{% extends "base.html" %}
{% load static %}
{% load time_filters %}

{% block content %}
    {% include "includes/sidebar.html" %}
    {% include "includes/header.html" %}
    <style>
      .table-agent tbody td:last-child {
        text-align: left;
      }
      .table-ratings tbody td:nth-child(3), .table-ratings tbody td:last-child {
        text-align: -webkit-center;
      }
    </style>
    <div class="main main-app p-3 p-lg-4">
      <div class="d-md-flex align-items-center justify-content-between mb-4">
        <div>
          <ol class="breadcrumb fs-sm mb-1">
            <li class="breadcrumb-item"><a href="#">Dashboard</a></li>

          </ol>
          <h4 class="main-title mb-0">Server Status</h4>
        </div>
        <div class="d-flex align-items-center gap-2 mt-3 mt-md-0">
          
        </div>
      </div>
      {% comment %} General States {% endcomment %}
      <div class="row g-3">
        <div class="col-sm-4">
          <div class="card card-one">
            <div class="card-body p-3">
              <div class="d-flex d-sm-block d-xl-flex align-items-center">
                <div class="helpdesk-icon bg-primary text-white"><i class="ri-bell-line"></i></div>
                <div class="ms-3 ms-sm-0 ms-xl-3 mt-sm-3 mt-xl-0">
                  <h2 class="card-value d-flex align-items-baseline mb-0" id="totalPhysicalServer"> {{ physical_servers.total_count }} </h2>
                  <h5 class="card-label text-dark fw-semibold mb-1">Physical Machines</h5>
                  <div class="mutual-badge">
                    <label style="font-size: 16px;"><span id="physicalServerGold">{{ physical_servers.gold_count }}</span> Gold, <span id="physicalServerSilver">{{ physical_servers.silver_count }}</span>  Silvers and <span id="physicalServerCpu">{{ physical_servers.cpu_count }}</span> Standard Machines</label>
                  </div>
                </div>
              </div>
            </div><!-- card-body -->
          </div><!-- card -->
        </div><!-- col -->
        <div class="col-sm-4">
          <div class="card card-one">
            <div class="card-body p-3">
              <div class="d-flex d-sm-block d-xl-flex align-items-center">
                <div class="helpdesk-icon bg-ui-02 text-white"><i class="ri-blaze-fill"></i></div>
                <div class="ms-3 ms-sm-0 ms-xl-3 mt-sm-3 mt-xl-0">
                  <h2 class="card-value d-flex align-items-baseline mb-0"> {{ total_virtual_servers }} </h2>
                  <h5 class="card-label text-dark fw-semibold mb-1">Virtual Machines (VMs)</h5>
                  <div class="mutual-badge">
                    <label style="font-size: 16px;">Created till yet</label>
                  </div>
                </div>
              </div>
            </div><!-- card-body -->
          </div><!-- card -->
        </div><!-- col -->
        <div class="col-sm-4">
          {% comment %} This card has been removed {% endcomment %}
        </div><!-- col -->
      </div>

      <p>&nbsp;</p>

      <div class="row g-3">
        <h3 class="card-value mb-0">Production Servers</h3>

        {% comment %} Production server cards {% endcomment %}
        {% for server in production_servers_status %}
          {% if server.status %}
            <div class="col-md-4">
              <div class="card card-one">
                <div class="card-body p-3">
                  <div class="row g-3 row-cols-auto align-items-center">
                    <div class="col">
                      <div class="apex-donut-one">
                        <div id="chartDonut{{ server.id }}"></div>
                        <div>
                          <h4 class="ff-numerals text-dark mb-0">UP</h4>
                          <span class="fs-xs text-secondary">Service</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-6 col-xl-7">
                      <h2 class="card-value mb-3">{{ server.server__name }}</h2>
                      <h5 class="card-label text-dark fw-semibold mb-1">{{ server.server__ip_address }}</h5>
                      <p class="fs-sm text-secondary mb-0">
                        <span class="badge bg-success" id="badgeStatus{{ server.id }}">RUNNING</span>
                        <span class="formatted-timestamp" data-timestamp="{{ server.timestamp|default:'None' }}">
                          {{ server.timestamp|default:"None" }}
                        </span>
                      </p>
                    </div>
                  </div><!-- row -->
                </div><!-- card-body -->
              </div><!-- card -->
            </div><!-- col -->
          {% else %}
            <div class="col-md-4">
              <div class="card card-one">
                <div class="card-body p-3">
                  <div class="row g-3 row-cols-auto align-items-center">
                    <div class="col">
                      <div class="apex-donut-one">
                        <div id="chartDonut{{ server.id }}"></div>
                        <div>
                          <h4 class="ff-numerals text-dark mb-0">DOWN</h4>
                          <span class="fs-xs text-secondary">Service</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-6 col-xl-7">
                      <h2 class="card-value mb-3">{{ server.server__name }}</h2>
                      <h5 class="card-label text-dark fw-semibold mb-1">{{ server.server__ip_address }}</h6>
                      <p class="fs-sm text-secondary mb-0">
                        <span class="badge bg-danger" id="badgeStatus{{ server.id }}">DOWN</span>
                        <span class="formatted-timestamp" data-timestamp="{{ server.timestamp|default:'None' }}">
                          {{ server.timestamp|default:"None" }}
                        </span>
                      </p>
                    </div>
                  </div><!-- row -->
                </div><!-- card-body -->
              </div><!-- card -->
            </div><!-- col -->
          {% endif %}
        {% endfor %}
      </div>

      <p>&nbsp;</p>

      {% comment %} Production server graphs {% endcomment %}
      <div class="row g-3">
        <div class="col-4">
          <figure class="highcharts-figure">
              <div id="containerDash"></div>
          </figure>
        </div>
        
        <div class="col-4">
          <figure class="highcharts-figure">
              <div id="containerAPI"></div>
          </figure>
        </div>

        <div class="col-md-4">
          <figure class="highcharts-figure">
              <div id="containerDB"></div>
          </figure>
        </div>
        
      </div>

      <p>&nbsp;</p>
      <div class="row g-3">
        <h3 class="card-value mb-0">Other Servers</h1>
        {% comment %} Other servers table {% endcomment %}
        {% for key, servers in all_other_servers_status.items %}
          {% if key == 'replication' %}
            <div class="col-6">
              <div class="card card-one">
                <div class="card-header">
                  <h6 class="card-title">Machine: 
                     {{ servers.0.physical_server_specs.name }}
                  </h6>
                  <nav class="nav nav-icon nav-icon-sm ms-auto">
                    <a href="" class="nav-link"><i class="ri-refresh-line"></i></a>
                    <a href="" class="nav-link"><i class="ri-more-2-fill"></i></a>
                  </nav>
                </div><!-- card-header -->
                <div class="card-body">
                  <div class="d-flex align-items-baseline gap-2 mb-0">
                    <h1 class="card-value mb-0">Replication Server</h1>
                  </div>
                  <p class="fs-sm text-secondary">{{ servers.0.physical_server_specs.model }}, {{ servers.0.physical_server_specs.specs }}
      
                </p>

                  <table class="table table-ratings mb-0">
                    <tbody>
                      {% for server in servers %}
                        <tr>
                          {% if server.latest_status.status %}
                            <td><span class="badge-dot bg-success"></span></td>                          
                          {% else %}
                            <td><span class="badge-dot bg-danger"></span></td>
                          {% endif %}
                          <td><strong>{{ server.server.name }} - ({{ server.server.ip_address }}) </strong></td>
                          
                          {% if server.latest_status.status %}
                            <td><span class="badge bg-success">RUNNING </span> </td>
                          {% else %}
                            <td><span class="badge bg-warning">DOWN </span> Since {{ server.first_down_time }} </td>
                          {% endif %}
                          
                          {% if server.latest_status.status %}
                            <td>
                              <div id="container{{server.server.ip_address}}" style="width: 100%; height: 40%;"></div>
                            </td>
                          {% else %}
                            <td> Down for arround <strong><b>{{ server.first_down_time|hours_since }}</b></strong> hours </td>
                          {% endif %}
                        </tr>                      
                      {% endfor %}
                    </tbody>
                  </table>
                </div><!-- card-body -->
              </div><!-- card -->
            </div><!-- col -->
          {% elif key == 'dr' %}
            <div class="col-6">
              <div class="card card-one">
                <div class="card-header">
                  <h6 class="card-title">Machine: 
                     {{ servers.0.physical_server_specs.name }}
                  </h6>
                  <nav class="nav nav-icon nav-icon-sm ms-auto">
                    <a href="" class="nav-link"><i class="ri-refresh-line"></i></a>
                    <a href="" class="nav-link"><i class="ri-more-2-fill"></i></a>
                  </nav>
                </div><!-- card-header -->
                <div class="card-body">
                  <div class="d-flex align-items-baseline gap-2 mb-0">
                    <h1 class="card-value mb-0">DR Server</h1>
                  </div>
                  <p class="fs-sm text-secondary">{{ servers.0.physical_server_specs.model }}, {{ servers.0.physical_server_specs.specs }}
      
                </p>

                  <table class="table table-ratings mb-0">
                    <tbody>
                      {% for server in servers %}
                        <tr>
                          {% if server.latest_status.status %}
                            <td><span class="badge-dot bg-success"></span></td>                          
                          {% else %}
                            <td><span class="badge-dot bg-danger"></span></td>
                          {% endif %}
                          <td><strong>{{ server.server.name }} - ({{ server.server.ip_address }})</strong></td>
                          
                          {% if server.latest_status.status %}
                            <td><span class="badge bg-success">RUNNING </span> </td>
                          {% else %}
                            <td><span class="badge bg-warning">DOWN </span> Since {{ server.first_down_time }} </td>
                          {% endif %}
                          

                          {% if server.latest_status.status %}
                            <td>
                              <div id="container{{server.server.ip_address}}" style="width: 100%; height: 40%;"></div>
                            </td>
                          {% else %}
                            <td> Down for arround <strong><b>{{ server.first_down_time|hours_since }}</b></strong> hours </td>
                          {% endif %}
                        </tr>                      
                      {% endfor %}
                    </tbody>
                  </table>
                </div><!-- card-body -->
              </div><!-- card -->
            </div><!-- col -->
          {% elif key == 'development' %}
            <div class="col-6">
              <div class="card card-one">
                <div class="card-header">
                  <h6 class="card-title">Machine: 
                     {{ servers.0.physical_server_specs.name }}
                  </h6>
                  <nav class="nav nav-icon nav-icon-sm ms-auto">
                    <a href="" class="nav-link"><i class="ri-refresh-line"></i></a>
                    <a href="" class="nav-link"><i class="ri-more-2-fill"></i></a>
                  </nav>
                </div><!-- card-header -->
                <div class="card-body">
                  <div class="d-flex align-items-baseline gap-2 mb-0">
                    <h1 class="card-value mb-0">Development Server</h1>
                  </div>
                  <p class="fs-sm text-secondary">{{ servers.0.physical_server_specs.model }}, {{ servers.0.physical_server_specs.specs }}
      
                </p>

                  <table class="table table-ratings mb-0">
                    <tbody>
                      {% for server in servers %}
                        <tr>
                          {% if server.latest_status.status %}
                            <td><span class="badge-dot bg-success"></span></td>                          
                          {% else %}
                            <td><span class="badge-dot bg-danger"></span></td>
                          {% endif %}
                          <td><strong>{{ server.server.name }} - ({{ server.server.ip_address }})</strong></td>
                          
                          {% if server.latest_status.status %}
                            <td><span class="badge bg-success">RUNNING </span> </td>
                          {% else %}
                            <td><span class="badge bg-warning">DOWN </span> Since {{ server.first_down_time }} </td>
                          {% endif %}
                          {% if server.latest_status.status %}
                            <td>
                              <div id="container{{server.server.ip_address}}" style="width: 100%; height: 40%;"></div>
                            </td>
                          {% else %}
                            <td> Down for arround <strong><b>{{ server.first_down_time|hours_since }}</b></strong> hours </td>
                          {% endif %}
                        </tr>                      
                      {% endfor %}
                    </tbody>
                  </table>
                </div><!-- card-body -->
              </div><!-- card -->
            </div><!-- col -->
          {% elif key == 'other' %}
            <div class="col-6">
              <div class="card card-one">
                <div class="card-header">
                  <h6 class="card-title">Machine: 
                    {{ servers.0.physical_server_specs.name }}
                  </h6>
                  <nav class="nav nav-icon nav-icon-sm ms-auto">
                    <a href="" class="nav-link"><i class="ri-refresh-line"></i></a>
                    <a href="" class="nav-link"><i class="ri-more-2-fill"></i></a>
                  </nav>
                </div><!-- card-header -->
                <div class="card-body">
                  <div class="d-flex align-items-baseline gap-2 mb-0">
                    <h1 class="card-value mb-0">Other Servers</h1>
                  </div>
                  <p class="fs-sm text-secondary">{{ servers.0.physical_server_specs.model }}, {{ servers.0.physical_server_specs.specs }}
      
                </p>

                  <table class="table table-ratings mb-0">
                    <tbody>
                      {% for server in servers %}
                        <tr>
                          {% if server.latest_status.status %}
                            <td><span class="badge-dot bg-success"></span></td>                          
                          {% else %}
                            <td><span class="badge-dot bg-danger"></span></td>
                          {% endif %}
                          <td><strong>{{ server.server.name }} - ({{ server.server.ip_address }})</strong></td>
                          
                          {% if server.latest_status.status %}
                            <td><span class="badge bg-success">RUNNING </span> </td>
                          {% else %}
                            <td><span class="badge bg-warning">DOWN </span> Since {{ server.first_down_time }} </td>
                          {% endif %}

                          {% if server.latest_status.status %}
                            <td>
                              <div id="container{{server.server.ip_address}}" style="width: 100%; height: 40%;"></div>
                            </td>
                          {% else %}
                            <td> Down for arround <strong><b>{{ server.first_down_time|hours_since }}</b></strong> hours </td>
                          {% endif %}
                          
                        </tr>                      
                      {% endfor %}
                    </tbody>
                  </table>
                </div><!-- card-body -->
              </div><!-- card -->
            </div><!-- col -->
          {% elif key == 'gis' %}
            <div class="col-12">
              <div class="card card-one">
                <div class="card-header">
                  <h6 class="card-title">Machine: 
                    {{ servers.0.physical_server_specs.name }}
                  </h6>
                  <nav class="nav nav-icon nav-icon-sm ms-auto">
                    <a href="" class="nav-link"><i class="ri-refresh-line"></i></a>
                    <a href="" class="nav-link"><i class="ri-more-2-fill"></i></a>
                  </nav>
                </div><!-- card-header -->
                <div class="card-body">
                  <div class="d-flex align-items-baseline gap-2 mb-0">
                    <h1 class="card-value mb-0">GIS Servers</h1>
                  </div>
                  <p class="fs-sm text-secondary">{{ servers.0.physical_server_specs.model }}, {{ servers.0.physical_server_specs.specs }}
      
                </p>

                  <table class="table table-ratings mb-0">
                    <tbody>
                      {% for server in servers %}
                        <tr>
                          {% if server.latest_status.status %}
                            <td><span class="badge-dot bg-success"></span></td>                          
                          {% else %}
                            <td><span class="badge-dot bg-danger"></span></td>
                          {% endif %}
                          <td><strong>{{ server.server.name }} - ({{ server.server.ip_address }})</strong></td>
                          
                          {% if server.latest_status.status %}
                            <td><span class="badge bg-success">RUNNING </span> </td>
                          {% else %}
                            <td><span class="badge bg-warning">DOWN </span> Since {{ server.first_down_time }} </td>
                          {% endif %}

                          {% if server.latest_status.status %}
                            <td>
                              <div id="container{{server.server.ip_address}}" style="width: 100%; height: 40%;"></div>
                            </td>
                          {% else %}
                            <td> Down for arround <strong><b>{{ server.first_down_time|hours_since }}</b></strong> hours </td>
                          {% endif %}
                          
                        </tr>                      
                      {% endfor %}
                    </tbody>
                  </table>
                </div><!-- card-body -->
              </div><!-- card -->
            </div><!-- col -->
          {% endif %}
        {% endfor %}
      </div>

      <p>&nbsp;</p>
      <div class="row g-3">
        <div class="col-12">
          <div class="card card-one">
            <div class="card-header">
              <h6 class="card-title">Servers List</h6>
              <nav class="nav nav-icon nav-icon-sm ms-auto">
                <a href="" class="nav-link"><i class="ri-refresh-line"></i></a>
                <a href="" class="nav-link"><i class="ri-more-2-fill"></i></a>
              </nav>
            </div><!-- card-header -->
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-agent mb-0">
                  <thead>
                    <tr>
                      <th>Server Name</th>
                      <th>IP Address</th>
                      <th>RAM</th>
                      <th>HDD</th>
                      <th>Group</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for server in all_virtual_servers %}
                      <tr>
                        <td>
                          {{ server.0 }}
                        </td>
                        <td>{{ server.1 }}</td>
                        <td>
                          {{ server.2 }}
                        </td>
                        <td> {{ server.3 }} </td>
                        <td>{{ server.4 }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div><!-- table-responsive -->
            </div><!-- card-body -->
          </div><!-- card -->
        </div><!-- col -->
      </div><!-- row -->

      <div class="main-footer mt-5">
        {% comment %} <span>&copy; 2023. Dashbyte. All Rights Reserved.</span>
        <span>Created by: <a href="http://themepixels.me" target="_blank">Themepixels</a></span> {% endcomment %}
      </div><!-- main-footer -->
    </div><!-- main -->

{% endblock content %}

{% block myScript %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      
      const prodServerStatuses = {{ production_servers_status|safe }};
      const all_other_servers_status_json = {{ all_other_servers_status_json|safe }};

      let charts = {}; // To store chart instances by server ID

      function updateCharts(prodServerStatuses) {
        prodServerStatuses.forEach(server => {
          const chartId = `chartDonut${server.id}`;
          const chartElement = document.querySelector(`#${chartId}`);
          const badgeElement = document.querySelector(`#badgeStatus${server.id}`);
          
          // Check if the chart already exists
          if (!charts[server.id]) {
            // Create the chart only once and store it in the charts object
            console.log("Creating new chart for: ", chartId);

            var optionDonut = {
              series: [68, 32], // Assuming the series values remain the same, modify if needed
              chart: {
                type: 'donut',
                width: '160',
                height: '160',
                parentHeightOffset: 0
              },
              colors: server.status ? ['#0db87b', '#cbf7b8'] : ['#d93945', '#f6aa9a'], // Up or down colors
              dataLabels: {
                enabled: false
              },
              legend: {
                show: false
              }
            };

            charts[server.id] = new ApexCharts(chartElement, optionDonut);
            charts[server.id].render();
          } else {
            // Update the existing chart's colors based on the server status
            console.log("Updating chart colors for: ", chartId);

            charts[server.id].updateOptions({
              colors: server.status ? ['#0db87b', '#cbf7b8'] : ['#d93945', '#f6aa9a'],
            });
          }

          if (server.status) {
            badgeElement.classList.remove('bg-danger');
            badgeElement.classList.add('bg-success');
            badgeElement.textContent = 'RUNNING';
          } else {
            badgeElement.classList.remove('bg-success');
            badgeElement.classList.add('bg-danger');
            badgeElement.textContent = 'DOWN';
          }
        });
      }

      // Function to format timestamp
      function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const options = {
          year: 'numeric',
          month: 'short', // Use 'long' for full month name
          day: 'numeric',
          // hour: 'numeric',
          // minute: 'numeric',
          // hour12: true // Use 12-hour clock
        };
        return date.toLocaleString('en-US', options);
      }

      // Format each timestamp in the formatted-timestamp class
      document.querySelectorAll('.formatted-timestamp').forEach(element => {
        const rawTimestamp = element.getAttribute('data-timestamp');
        if (rawTimestamp) {
          const formatted = formatTimestamp(rawTimestamp);
          element.textContent = formatted; // Replace text with formatted date
        }
      });

      updateCharts(prodServerStatuses);

      // Fetch data for all other servers
      function fetchServerData() {
        $.ajax({
            url: "{% url 'server_monitor' %}",
            type: "GET",
            success: function (data) {
                console.log("response data => ", data);
                $('#totalPhysicalServer').html(data.physical_servers.total_count);
                $('#physicalServerGold').html(data.physical_servers.gold_count);
                $('#physicalServerSilver').html(data.physical_servers.silver_count);
                $('#physicalServerCpu').html(data.physical_servers.cpu_count);
                updateCharts(data.production_servers_status);
            },
            error: function(xhr, status, error) {
                console.log("Error fetching data => ", error);
            }
        });
      }

      $(document).ready(function () {
          fetchServerData(); // Initial data fetch
          setInterval(fetchServerData, 5000); // Set up polling
      });

      // Create the DB chart on page load
      function createChartDB() {
        Highcharts.chart('containerDB', {
              chart: {
                  type: 'spline',
                  color: '#32CD32',
                  animation: Highcharts.svg, // Animation is enabled for updating
                  marginRight: 10,
                  fillColor: {
                      linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                      stops: [
                          [0, '#32CD32'],
                          [1, '#32CD3200']
                      ]
                  },
                  events: {
                      load: function () {
                        const series = this.series[0];
                        const maxPoints = 20; // Set the maximum number of points to display

                        // Initial fetch to get the first data point
                        fetch('/monitor/get_db_data/')
                          .then(response => response.json())
                          .then(data => {
                              const x = (new Date()).getTime(); // Current time
                              const y = data.value; // Active database connections count
                              
                              // Add the initial point
                              series.addPoint([x, y], true, false); // false for redrawing immediately
                              
                              // Start polling after the initial load
                              setInterval(() => {
                                  console.log("checking container db server =================");
                                  fetch('/monitor/get_db_data/')
                                      .then(response => response.json())
                                      .then(data => {
                                          const x = (new Date()).getTime(); // Current time
                                          const y = data.value; // Active database connections count

                                          // Add new points on each fetch and shift the first point if necessary
                                          series.addPoint([x, y], true, series.data.length >= maxPoints); // Shift the oldest point if we exceed maxPoints
                                      })
                                      .catch(error => console.error('Fetch error:', error));
                              }, 2000); // Polling interval in milliseconds
                          })
                          .catch(error => console.error('Fetch error during initial load:', error));
                      }
                  }
              },
              time: {
                  useUTC: false
              },
              title: {
                  text: 'Live-Dashboard Server (8.8.8.8)'
              },
              xAxis: {
                  type: 'datetime',
                  tickPixelInterval: 150
              },
              yAxis: {
                  title: {
                      text: 'Response Time'
                  },
                  plotLines: [{
                      value: 0,
                      width: 1,
                      color: '#808080'
                  }]
              },
              tooltip: {
                  formatter: function () {
                      return `<b>${Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x)}</b><br/>` +
                            `<b>${this.y} Response Time</b>`;
                  }
              },
              legend: {
                  enabled: false
              },
              credits: {
                  enabled: false
              },
              exporting: {
                  enabled: false
              },
              plotOptions: {
                  areaspline: {
                      color: '#32CD32',
                      fillColor: {
                          linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                          stops: [
                              [0, '#32CD32'],
                              [1, '#32CD3200']
                          ]
                      },
                      threshold: null,
                      marker: {
                          enabled: true
                      }
                  }
              },
              series: [{
                name: 'Response Time',
                data: (function () {
                  // Generate an array of initial data points
                  const data = [];
                  const time = (new Date()).getTime();
                  for (let i = -19; i <= 0; i += 1) {
                      data.push({
                          x: time + i * 1000,
                          y: Math.floor(Math.random() * 3 + Math.random() * 2)
                      });
                  }
                  return data;
                }())
              }]
          });
      }
      createChartDB();



      // Create the API chart on page load
      function createChartAPI() {
        Highcharts.chart('containerAPI', {
          chart: {
              type: 'areaspline',
              color: '#32CD32',
              animation: Highcharts.svg, // Animation is enabled for updating
              marginRight: 10,
              fillColor: {
                  linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                  stops: [
                      [0, '#32CD32'],
                      [1, '#32CD3200']
                  ]
              },
              events: {
                  load: function () {
                  const series = this.series[0];
                  const maxPoints = 20;
                    
                  fetch('/monitor/get_api_data/')
                    .then(response => response.json())
                    .then(data => {
                        const x = (new Date()).getTime(); // Current time
                        const y = data.value; // Active database connections count
                        
                        // Add the initial point
                        series.addPoint([x, y], true, false); // false for redrawing immediately
                        
                        // Start polling after the initial load
                        setInterval(() => {
                            fetch('/monitor/get_api_data/')
                                .then(response => response.json())
                                .then(data => {
                                    const x = (new Date()).getTime(); // Current time
                                    const y = data.value; // Active database connections count

                                    // Add new points on each fetch and shift the first point if necessary
                                    series.addPoint([x, y], true, series.data.length >= maxPoints); // Shift the oldest point if we exceed maxPoints
                                })
                                .catch(error => console.error('Fetch error:', error));
                        }, 2000); // Polling interval in milliseconds
                    })
                    .catch(error => console.error('Fetch error during initial load:', error));
                  
                  }
              }
          },
          time: {
              useUTC: false
          },
          title: {
              text: 'Live-Database Server (1.1.1.1)'
          },
          xAxis: {
              type: 'datetime',
              tickPixelInterval: 150
          },
          yAxis: {
              title: {
                  text: 'Response Time'
              },
              plotLines: [{
                  value: 0,
                  width: 1,
                  color: '#808080'
              }]
          },
          tooltip: {
              formatter: function () {
                  return `<b>${Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x)}</b><br/>` +
                        `<b>${this.y} Response Time</b>`;
              }
          },
          legend: {
              enabled: false
          },
          credits: {
              enabled: false
          },
          exporting: {
              enabled: false
          },
          plotOptions: {
              areaspline: {
                  color: '#32CD32',
                  fillColor: {
                      linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                      stops: [
                          [0, '#32CD32'],
                          [1, '#32CD3200']
                      ]
                  },
                  threshold: null,
                  marker: {
                      enabled: true
                  }
              }
          },
          series: [{
              name: 'Response Time',
              data: (function () {
                // Generate an array of initial data points
                const data = [];
                const time = (new Date()).getTime();
                for (let i = -19; i <= 0; i += 1) {
                    data.push({
                        x: time + i * 1000,
                        y: Math.floor(Math.random() * 4 + Math.random() * 3)
                    });
                }
                return data;
              }())
          }]
        });
      }
      createChartAPI();

      // Create the Dashboard chart on page load
      function createChartDash() {
        Highcharts.chart('containerDash', {
            chart: {
                type: 'areaspline',
                color: '#32CD32',
                animation: Highcharts.svg, // Animation is enabled for updating
                marginRight: 10,
                fillColor: {
                    linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                    stops: [
                        [0, '#32CD32'],
                        [1, '#32CD3200']
                    ]
                },
                events: {
                    load: function () {
                        const series = this.series[0];
                        const maxPoints = 20; // Set the maximum number of points to display

                        // Initial fetch to get the first data point
                        fetch('/monitor/get_dasboard_data/')
                          .then(response => response.json())
                          .then(data => {
                              const x = (new Date()).getTime(); // Current time
                              const y = data.value; // Active database connections count
                              
                              // Add the initial point
                              series.addPoint([x, y], true, false); // false for redrawing immediately
                              
                              // Start polling after the initial load
                              setInterval(() => {
                                  fetch('/monitor/get_dasboard_data/')
                                      .then(response => response.json())
                                      .then(data => {
                                          console.log("res data => ", data)
                                          const x = (new Date()).getTime(); // Current time
                                          const y = data.value; // Active database connections count

                                          // Add new points on each fetch and shift the first point if necessary
                                          series.addPoint([x, y], true, series.data.length >= maxPoints); // Shift the oldest point if we exceed maxPoints
                                      })
                                      .catch(error => console.error('Fetch error:', error));
                              }, 2000); // Polling interval in milliseconds
                          })
                          .catch(error => console.error('Fetch error during initial load:', error));
                    }
                }
            },
            time: {
                useUTC: false
            },
            title: {
                text: 'Live-API Server (142.250.190.78)'
            },
            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150
            },
            yAxis: {
                title: {
                    text: 'Response Time'
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                formatter: function () {
                    return `<b>${Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x)}</b><br/>` +
                          `<b>${this.y} Response Time</b>`;
                }
            },
            legend: {
                enabled: false
            },
            credits: {
                enabled: false
            },
            exporting: {
                enabled: false
            },
            plotOptions: {
                areaspline: {
                    color: '#32CD32',
                    fillColor: {
                        linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                        stops: [
                            [0, '#32CD32'],
                            [1, '#32CD3200']
                        ]
                    },
                    threshold: null,
                    marker: {
                        enabled: true
                    }
                }
            },
            series: [{
              name: 'Response Time',
              data: (function () {
                // Generate an array of initial data points
                const data = [];
                const time = (new Date()).getTime();
                for (let i = -19; i <= 0; i += 1) {
                    data.push({
                        x: time + i * 1000,
                        y: Math.floor(Math.random() * 6)
                    });
                }
                return data;
              }())
            }]
        });
      }
      createChartDash();


      // Function to fetch data from the backend for a specific server IP
      async function fetchServerData(server_ip) {
        print("server ip ======= ======= ===== >>>>> ", server_ip)
        if (!server_ip) {
          console.error("Invalid server IP:", server_ip);
          return null;
        }
        try {
            const response = await fetch(`/monitor/get_server_status/${server_ip}/`);
            if (response.ok) {
                const result = await response.json();
                if (result.status_data && result.status_data.length > 0) {
                    const latestStatus = result.status_data[0];
                    return {
                        timestamp: (new Date()).getTime(),
                        response_time: latestStatus.response_time
                    };
                }
            } else {
                console.error(`Error fetching data for server ${server_ip}`);
            }
        } catch (error) {
            console.error(`Failed to fetch server data: ${error}`);
        }
        return null;
      }


      // On chart load, start an interval that adds points to the chart.
      const onChartLoad = function (server_ip) {
          const chart = this,
              series = chart.series[0];

          setInterval(async function () {
              console.log("Loading chart for server IP:", server_ip);
              const dataPoint = await fetchServerData(server_ip);
              if (dataPoint) {
                  const x = dataPoint.timestamp; // timestamp from the backend
                  const y = parseFloat(dataPoint.response_time); // status value from the backend
                  series.addPoint([x, y], true, series.data.length >= 15);
              }
          }, 3000);
      };

      // Create the initial data
      const data = (function () {
          const data = [];
          const time = new Date().getTime();

          for (let i = -19; i <= 0; i += 1) {
              data.push({
                  x: time + i * 1000,
                  y: Math.random()
              });
          }
          return data;
      }());

      // Plugin to add a pulsating marker on add point
      Highcharts.addEvent(Highcharts.Series, 'addPoint', e => {
        const point = e.point,
            series = e.target;

        if (!series.pulse) {
            series.pulse = series.chart.renderer.circle()
                .add(series.markerGroup);
        }

        setTimeout(() => {
            series.pulse
                .attr({
                    x: series.xAxis.toPixels(point.x, true),
                    y: series.yAxis.toPixels(point.y, true),
                    r: series.options.marker.radius,
                    opacity: 1,
                    fill: series.color
                })
                .animate({
                    r: 20,
                    opacity: 0
                }, {
                    duration: 1000
                });
        }, 1);
      });

      // Create charts for all other servers dynamically
      for (const [key, val] of Object.entries(all_other_servers_status_json)) {
        for (const i in val) {
          console.log("a single server is => ", val);
          if (val[i].latest_status.status) {
            const server_ip = val[i].server.ip_address;
            Highcharts.chart('container' + server_ip, {
                chart: {
                    type: 'areaspline',
                    events: {
                        load: function () {
                          onChartLoad.call(this, server_ip); 
                        }
                    },
                    width: 200,       // Set chart width to fit cell
                    height: 30,     // Set chart height to fit cell
                    backgroundColor: 'transparent',
                    spacing: [10, 10, 0, 10] // Remove all spacing
                },
                credits: {
                    enabled: false // Remove the Highcharts watermark
                },

                time: {
                    useUTC: false
                },

                title: {
                    text: null // Remove the title
                },

                xAxis: {
                    type: 'datetime',
                    labels: {
                        enabled: false // Hide x-axis labels
                    },
                    tickLength: 0,
                    lineWidth: 0
                },

                yAxis: {
                    title: {
                        text: null // Remove y-axis title
                    },
                    labels: {
                        enabled: false // Hide y-axis labels
                    },
                    gridLineWidth: 0,
                    lineWidth: 0
                },

                tooltip: {
                    enabled: false // Disable tooltip
                },

                legend: {
                    enabled: false // Disable legend
                },

                exporting: {
                    enabled: false // Disable export button
                },

                series: [
                    {
                        name: 'Random data',
                        lineWidth: 1,
                        marker: {
                          enabled: true,
                          radius: 2 // Adjust marker size as needed
                        },
                        color: Highcharts.getOptions().colors[2],
                        data
                    }
                ]
            });
          }
        }
      }

      window.print = function() {
        console.log("Blocked unwanted print trigger.");
      };
    });
  </script>
{% endblock myScript %}



